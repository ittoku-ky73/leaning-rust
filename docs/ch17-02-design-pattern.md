# オブジェクト指向デザインパターン

> Ref: https://doc.rust-jp.rs/book-ja/ch17-03-oo-design-patterns.html

ステートパターンは、オブジェクト指向デザインパターンの1つです。
このパターンは値が一連のステートオブジェクトで表す内部状態を持ち、その内部状態に基づいて値の振る舞いが変化するというものです。
ステートオブジェクトは機能を共有します。Rustでは構造体とトレイトを使用します。
各ステートオブジェクトは自身の振る舞いと別の状態に変化すべき時に責任を持ちます。
ステートオブジェクトを保持する値は、状態ごとの異なる振る舞いや、いつ状態が移行するか何も知りません。

ステートパターンを使用することはプログラムの業務要件が変わる時、状態を保持する値のコードや、値を使用するコードを変更する必要がないことを意味します。
ステートデザインパターンの例と、Rustでの使用方法を見ていきましょう。

例のブログ記事のワークフローは次の通りです。

1. 空の草稿を作成する
2. 査読機能を追加する
3. 記事が承認されたら公開する
4. 公開された記事のみを表示して、未承認の記事は公開しない

それ以外の記事に対する変更は効果をもつべきではありません。
例えば、査読を要求する前にブログ記事の草稿を承認すると、記事は非公開の草稿のままになるべきです。

以下のコードは上記のワークフローに則って作成したライブラリクレートに実装するAPIの例です。
まだコンパイルはできません。

```rust
extern crate oop;
use oop::Post;

let mut post = Post::new();

post.add_text("I ate a salad for lunch today");
assert_eq!("", post.content());

post.request_review();
assert_eq!("", post.content());

post.approve();
assert_eq!("I ate a salad for lunch today", post.content());
```

ユーザーが`Post::new`で新しいブログ記事の草稿を作成します。
そして草稿状態の間にブログ記事にテキストを追加できるようにします。
承認前に記事の内容を即座に得ようとしたら、記事はまだ走行なので何も起きません。
デモ目的でコードに`assert_eq!`を追加しています。
この単体テストは、ブログ記事の走行が`content`メソッドから空の文字列が返ってくることをテストします。

次に記事の査読を要求し、査読を待機している間`content`に空の文字列を返します。
記事が承認されたら公開し、`content`を呼び出した時に記事のテキストが返されるということです。

クレートから相互作用している唯一の型は`Post`のみです。
この型はステートパターンを使用し、記事がなり得る種々の状態を表す「草稿、査読待ち、公開中」のステートオブジェクトのうち1つになる値を保持します。
状態の変更には`Post`型内部で管理します。
`Post`インスタンスのライブラリ使用者が状態の変化を直接管理する必要はありません。
またユーザーは査読前に記事を公開するなど状態を誤ることもないでしょう。

### Postを定義

ライブラリの実装に取り掛かりましょう！
何らかの内容を保持する公開の`Post`構造体が必要なので、構造体の定義と関連する公開用の`Post`インスタンスを生成する`new`関数から始めましょう。
また非公開の`State`トレイトも作成します。それから、`Post`は`state`という非公開のフィールドに、`Option`で`Box<State>`のトレイトオブジェクトを保持します。

```rust
pub struct Post {
    state: Option<Box<State>>,
    content: String,
}

impl Post {
    pub fn new() -> Post {
        Post {
            state: Some(Box::new(Draft {})),
            content: String::new(),
        }
    }
}

trait State {}

struct Draft {}

impl State for Draft {}
```

`State`トレイトは異なる記事の状態で共有される振る舞いを定義し、`Draft, PendingReview, Published`状態は全て、`State`トレイトを実装します。
今はトレイトにメソッドは何もなく、`Draft`が記事の初期状態にしたい状態なので、その状態だけを定義することから始めます。

新しい`Post`を作る際、`state`フィールドは`Box`を保持する`Some`値にセットします。
この`Box`が`Draft`構造体の新しいインスタンスを指します。
これにより新しい`Post`を作るたびに、草稿から始まることが保証されます。
`Post`の`state`フィールドは非公開なので、`Post`を他の状態で作成する方法はないのです。
`Post::new`関数では、`content`フィールドを新しい空の`String`をセットします。

## 記事の内容を格納
